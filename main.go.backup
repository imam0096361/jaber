package main

import (
	"database/sql"
	"encoding/json"
	"fmt"
	"io"
	"log"
	"net/http"
	"os"
	"path/filepath"
	"time"

	_ "github.com/mattn/go-sqlite3"
)

type Article struct {
	ID       int       `json:"id"`
	Title    string    `json:"title"`
	Content  string    `json:"content"`
	Category string    `json:"category"`
	Author   string    `json:"author"`
	Image    *string   `json:"image"`
	Created  time.Time `json:"created"`
	Featured bool      `json:"featured"`
}

var db *sql.DB

func init() {
	var err error
	db, err = sql.Open("sqlite3", "./news.db")
	if err != nil {
		log.Fatal("Database connection error:", err)
	}

	// Create tables
	createTables()

	// Insert sample data
	insertSampleData()
}

func createTables() {
	query := `
	CREATE TABLE IF NOT EXISTS articles (
		id INTEGER PRIMARY KEY AUTOINCREMENT,
		title TEXT NOT NULL,
		content TEXT NOT NULL,
		category TEXT NOT NULL,
		author TEXT NOT NULL,
		image TEXT,
		created DATETIME DEFAULT CURRENT_TIMESTAMP,
		featured BOOLEAN DEFAULT 0
	);
	`
	_, err := db.Exec(query)
	if err != nil {
		log.Fatal("Table creation error:", err)
	}
}

func insertSampleData() {
	var count int
	db.QueryRow("SELECT COUNT(*) FROM articles").Scan(&count)

	if count > 0 {
		return // Data already exists
	}

	articles := []Article{
		{
			Title:    "বাংলাদেশ অর্থনীতিতে নতুন মাইলফলক অর্জন",
			Content:  "বাংলাদেশের অর্থনীতি এই বছর নতুন উচ্চতায় পৌঁছেছে। জিডিপি বৃদ্ধির হার ৬.৫ শতাংশ অতিক্রম করেছে এবং রপ্তানি আয় রেকর্ড পরিমাণে বৃদ্ধি পেয়েছে। বিশেষজ্ঞরা বলছেন যে এই ইতিবাচক প্রবণতা আগামী বছরও অব্যাহত থাকবে।",
			Category: "জাতীয়",
			Author:   "রহিম আহমেদ",
			Featured: true,
		},
		{
			Title:    "ঢাকা ক্রিকেট ক্লাব আন্তর্জাতিক টুর্নামেন্টে চ্যাম্পিয়ন",
			Content:  "ঢাকা ক্রিকেট ক্লাব এশিয়া কাপ টুর্নামেন্টে বিজয়ী হয়েছে। দলটি ফাইনালে স্থানীয় প্রতিদ্বন্দ্বীদের পরাজিত করে চ্যাম্পিয়ন হওয়ার গৌরব অর্জন করেছে।",
			Category: "খেলাধুলা",
			Author:   "করিম খান",
			Featured: true,
		},
		{
			Title:    "নতুন প্রযুক্তি দিয়ে শিক্ষা ব্যবস্থা পরিবর্তন",
			Content:  "প্রযুক্তির কল্যাণে শিক্ষা ব্যবস্থা ক্রমাগত পরিবর্তিত হচ্ছে। কৃত্রিম বুদ্ধিমত্তা এবং মেশিন লার্নিং এখন শিক্ষার্থীদের ব্যক্তিগত শিক্ষণ পদ্ধতি তৈরি করতে সাহায্য করছে।",
			Category: "প্রযুক্তি",
			Author:   "আলি হোসেন",
			Featured: false,
		},
		{
			Title:    "স্বাস্থ্যকর জীবনযাত্রার জন্য নতুন গাইডলাইন",
			Content:  "বিশ্ব স্বাস্থ্য সংস্থা সম্প্রতি নতুন স্বাস্থ্যকর জীবনযাত্রার গাইডলাইন প্রকাশ করেছে। এতে দৈনিক ব্যায়াম, পুষ্টিকর খাবার এবং যথাযথ ঘুমের উপর জোর দেওয়া হয়েছে।",
			Category: "স্বাস্থ্য",
			Author:   "ডাক্তার সালমা",
			Featured: false,
		},
	}

	for _, article := range articles {
		query := `INSERT INTO articles (title, content, category, author, featured) VALUES (?, ?, ?, ?, ?)`
		_, err := db.Exec(query, article.Title, article.Content, article.Category, article.Author, article.Featured)
		if err != nil {
			log.Println("Error inserting sample data:", err)
		}
	}
}

// API Endpoints
func getArticles(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	category := r.URL.Query().Get("category")
	search := r.URL.Query().Get("search")

	query := "SELECT id, title, content, category, author, image, created, featured FROM articles WHERE 1=1"
	var args []interface{}

	if category != "" && category != "সব" {
		query += " AND category = ?"
		args = append(args, category)
	}

	if search != "" {
		query += " AND (title LIKE ? OR content LIKE ?)"
		searchTerm := "%" + search + "%"
		args = append(args, searchTerm, searchTerm)
	}

	query += " ORDER BY created DESC LIMIT 50"

	rows, err := db.Query(query, args...)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}
	defer rows.Close()

	var articles []Article
	for rows.Next() {
		var a Article
		err := rows.Scan(&a.ID, &a.Title, &a.Content, &a.Category, &a.Author, &a.Image, &a.Created, &a.Featured)
		if err != nil {
			log.Println("Error scanning article:", err)
			continue
		}
		articles = append(articles, a)
	}

	if articles == nil {
		articles = []Article{}
	}

	json.NewEncoder(w).Encode(articles)
}

func getFeaturedArticles(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	rows, err := db.Query("SELECT id, title, content, category, author, image, created, featured FROM articles WHERE featured = 1 ORDER BY created DESC LIMIT 5")
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}
	defer rows.Close()

	var articles []Article
	for rows.Next() {
		var a Article
		err := rows.Scan(&a.ID, &a.Title, &a.Content, &a.Category, &a.Author, &a.Image, &a.Created, &a.Featured)
		if err != nil {
			log.Println("Error scanning article:", err)
			continue
		}
		articles = append(articles, a)
	}

	if articles == nil {
		articles = []Article{}
	}

	json.NewEncoder(w).Encode(articles)
}

func getArticleByID(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	id := r.URL.Query().Get("id")
	if id == "" {
		http.Error(w, "ID required", http.StatusBadRequest)
		return
	}

	var a Article
	err := db.QueryRow("SELECT id, title, content, category, author, image, created, featured FROM articles WHERE id = ?", id).Scan(
		&a.ID, &a.Title, &a.Content, &a.Category, &a.Author, &a.Image, &a.Created, &a.Featured,
	)
	if err != nil {
		http.Error(w, "Article not found", http.StatusNotFound)
		return
	}

	json.NewEncoder(w).Encode(a)
}

func getCategories(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	rows, err := db.Query("SELECT DISTINCT category FROM articles")
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}
	defer rows.Close()

	var categories []string
	categories = append(categories, "সব")
	for rows.Next() {
		var cat string
		err := rows.Scan(&cat)
		if err != nil {
			log.Println("Error scanning category:", err)
			continue
		}
		categories = append(categories, cat)
	}

	json.NewEncoder(w).Encode(categories)
}

func addArticle(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	if r.Method != http.MethodPost {
		http.Error(w, "Method not allowed", http.StatusMethodNotAllowed)
		return
	}

	var a Article
	err := json.NewDecoder(r.Body).Decode(&a)
	if err != nil {
		http.Error(w, "Invalid JSON", http.StatusBadRequest)
		return
	}

	// Validate required fields
	if a.Title == "" || a.Content == "" || a.Category == "" || a.Author == "" {
		http.Error(w, "Title, Content, Category, and Author are required", http.StatusBadRequest)
		return
	}

	query := `INSERT INTO articles (title, content, category, author, image, featured) VALUES (?, ?, ?, ?, ?, ?)`
	result, err := db.Exec(query, a.Title, a.Content, a.Category, a.Author, a.Image, a.Featured)
	if err != nil {
		http.Error(w, "Error inserting article: "+err.Error(), http.StatusInternalServerError)
		return
	}

	id, err := result.LastInsertId()
	if err != nil {
		http.Error(w, "Error getting article ID", http.StatusInternalServerError)
		return
	}

	a.ID = int(id)
	a.Created = time.Now()

	json.NewEncoder(w).Encode(map[string]interface{}{
		"message": "Article added successfully",
		"article": a,
	})
}

func uploadImage(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")

	if r.Method != http.MethodPost {
		http.Error(w, "Method not allowed", http.StatusMethodNotAllowed)
		return
	}

	// Create uploads directory if it doesn't exist
	uploadsDir := "static/uploads"
	if err := os.MkdirAll(uploadsDir, 0755); err != nil {
		http.Error(w, "Error creating uploads directory", http.StatusInternalServerError)
		return
	}

	// Parse file upload
	err := r.ParseMultipartForm(10 << 20) // 10 MB max
	if err != nil {
		http.Error(w, "File too large", http.StatusBadRequest)
		return
	}

	file, handler, err := r.FormFile("image")
	if err != nil {
		http.Error(w, "Error retrieving file", http.StatusBadRequest)
		return
	}
	defer file.Close()

	// Create unique filename
	filename := fmt.Sprintf("%d_%s", time.Now().UnixNano(), handler.Filename)
	filePath := filepath.Join(uploadsDir, filename)

	// Save file
	dst, err := os.Create(filePath)
	if err != nil {
		http.Error(w, "Error saving file", http.StatusInternalServerError)
		return
	}
	defer dst.Close()

	// Copy file content
	_, err = io.Copy(dst, file)
	if err != nil {
		http.Error(w, "Error writing file", http.StatusInternalServerError)
		return
	}

	imageURL := "/static/uploads/" + filename

	json.NewEncoder(w).Encode(map[string]interface{}{
		"message": "Image uploaded successfully",
		"url":     imageURL,
	})
}

func main() {
	defer db.Close()

	// Serve static files
	staticDir := "static"
	if wd, err := os.Getwd(); err == nil {
		staticDir = filepath.Join(wd, "static")
	}

	http.Handle("/static/", http.StripPrefix("/static/", http.FileServer(http.Dir(staticDir))))

	// API routes
	http.HandleFunc("/api/articles", getArticles)
	http.HandleFunc("/api/featured", getFeaturedArticles)
	http.HandleFunc("/api/article", getArticleByID)
	http.HandleFunc("/api/categories", getCategories)
	http.HandleFunc("/api/add-article", addArticle)
	http.HandleFunc("/api/upload-image", uploadImage)

	// Home page
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		http.ServeFile(w, r, "static/index.html")
	})

	port := ":9999"
	fmt.Printf("News Portal running on http://localhost:9999\n")
	log.Fatal(http.ListenAndServe(port, nil))
}
